pipeline {
    agent any
    stages {
        stage ( 'Checkout') {
            steps {
                stage('Build') {
            steps {
                sh 'dotnet build --configuration Release'
            }
        }

        stage('Run Tests') {
            steps {
                sh 'dotnet test --logger trx --results-directory TestResults'
            }
        }

        stage('Convert TRX to xUnit') {
            steps {
                sh 'dotnet tool install --global trx2junit'  
                sh 'trx2junit TestResults/*.trx'  
            }
            }
        }
            
        }

        stage('Publish Test Results') {
            steps {
                xunit(
                    thresholds: [
                        failed(failureThreshold: '0'),
                        skipped(failureThreshold: '0')
                    ],
                    tools: [JUnit(deleteOutputFiles: true, failIfNotNew: true, pattern: 'TestResults/*.xml', skipNoTestFiles: true, stopProcessingIfError: true)]
                )
            }
        }
        
    }
        post {
        always {
            archiveArtifacts artifacts: 'TestResults/*.xml', fingerprint: true
            junit 'TestResults/*.xml'
        }
    }
}